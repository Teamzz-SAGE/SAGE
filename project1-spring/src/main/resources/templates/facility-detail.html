<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${detail.name} + ' 상세 정보'">시설 상세 정보</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/footer.css}">
  <link rel="stylesheet" th:href="@{/css/facility-detail.css}">
</head>
<body>

<div th:replace="header :: header"></div>

<main>
  <div class="container">
    <div class="detail-header">
      <h1 th:text="${detail.name}">기관명</h1>
      <p th:text="${detail.address}">주소</p>
    </div>

    <div class="detail-image">
      <img th:src="${detail.mainImage != null ? detail.mainImage : (detail.image != null ? detail.image : '/img/default.jpg')}"
           alt="대표사진" onerror="this.onerror=null;this.src='/img/default.jpg';" />
    </div>

    <div class="detail-section">
      <h2>기본 정보</h2>
      <table class="info-table">
        <tr>
          <th>전화번호</th>
          <td th:text="${detail.phone}"></td>
          <th>정원</th>
          <td th:text="${detail.capacity != null ? detail.capacity : '정보 없음'}"></td>
        </tr>
        <tr>
          <th>현원</th>
          <td th:text="${detail.currentOccupancy != null ? detail.currentOccupancy : '정보 없음'}"></td>
          <th>대기인원</th>
          <td th:text="${detail.waitingList != null ? detail.waitingList : '정보 없음'}"></td>
        </tr>
        <tr>
          <th>이용가능여부</th>
          <td th:text="${detail.availability != null ? detail.availability : '정보 없음'}"></td>
          <th>본인부담금</th>
          <td th:text="${detail.selfPay != null ? detail.selfPay : '정보 없음'}"></td>
        </tr>
        <tr th:if="${detail.homepage != null}">
          <th>홈페이지</th>
          <td colspan="3">
            <a th:href="${detail.homepage}" th:text="${detail.homepage}" target="_blank"></a>
          </td>
        </tr>
      </table>
    </div>

    <div class="detail-section" th:if="${detail.programOperation != null}">
      <h2>프로그램 운영</h2>
      <p class="program-operations" th:text="${detail.programOperation}">제공되는 프로그램 정보</p>
    </div>

    <div class="detail-section" th:if="${detail.transportation != null or detail.parkingFacility != null}">
      <h2>교통 및 주차</h2>
      <table class="info-table">
        <tr th:if="${detail.transportation != null}">
          <th>교통편</th>
          <td class="transportation-info" th:text="${detail.transportation}"></td>
        </tr>
        <tr th:if="${detail.parkingFacility != null}">
          <th>주차시설</th>
          <td th:text="${detail.parkingFacility}"></td>
        </tr>
      </table>
    </div>

    <div class="detail-section" th:if="${detail.staffStatus != null}">
      <h2>인력 현황</h2>
      <p class="staff-info" th:text="${detail.staffStatus}">인력 현황 정보</p>
    </div>

    <div class="detail-section" th:if="${detail.rating != null or detail.totalScore != null}">
      <h2>평가 정보</h2>
      <table class="info-table">
        <tr th:if="${detail.evaluationDate != null}">
          <th>평가일자</th>
          <td th:text="${#temporals.format(detail.evaluationDate, 'yyyy-MM-dd')}"></td>
        </tr>
        <tr th:if="${detail.rating != null}">
          <th>평점</th>
          <td th:text="${detail.rating}"></td>
        </tr>
        <tr th:if="${detail.totalScore != null}">
          <th>총점</th>
          <td th:text="${detail.totalScore}"></td>
        </tr>
        <tr th:if="${detail.establishDate != null}">
          <th>설립일자</th>
          <td th:text="${#temporals.format(detail.establishDate, 'yyyy-MM-dd')}"></td>
        </tr>
      </table>
    </div>

    <div class="detail-section" th:if="${detail.recommendation != null}">
      <h2>추천</h2>
      <p th:text="${detail.recommendation}">이 시설에 대한 추천 사유 또는 특징</p>
    </div>

    <a href="/facilities" class="back-button">목록으로 돌아가기</a>
  </div>
</main>

<div th:replace="footer :: footer"></div>

<script th:inline="javascript">
// 최근 본 게시글 저장 기능
document.addEventListener('DOMContentLoaded', function() {
    // 시설 정보 가져오기
    const facilityName = /*[[${detail.name}]]*/ '기관명';
    const facilityAddress = /*[[${detail.address}]]*/ '주소';
    const facilityImage = /*[[${detail.mainImage != null ? detail.mainImage : (detail.image != null ? detail.image : '/img/default.jpg')}]]*/ '/img/default.jpg';
    const currentDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD 형식
    
    // 최근 본 게시글 저장
    saveRecentFacility(facilityName, facilityAddress, facilityImage, currentDate);
    
    // 표 내용 가독성 개선
    formatTableContent();
});

function saveRecentFacility(name, address, image, date) {
    // localStorage에서 기존 최근 본 게시글 가져오기
    let recentFacilities = JSON.parse(localStorage.getItem('recentFacilities') || '[]');
    
    // 중복 제거 (같은 이름의 시설이 있으면 제거)
    recentFacilities = recentFacilities.filter(facility => facility.name !== name);
    
    // 새로운 시설 정보를 맨 앞에 추가
    const newFacility = {
        name: name,
        address: address,
        image: image,
        date: date
    };
    
    recentFacilities.unshift(newFacility);
    
    // 최대 4개까지만 유지
    if (recentFacilities.length > 4) {
        recentFacilities = recentFacilities.slice(0, 4);
    }
    
    // localStorage에 저장
    localStorage.setItem('recentFacilities', JSON.stringify(recentFacilities));
}

// 표 내용 가독성 개선 함수
function formatTableContent() {
    // 프로그램 운영 - 콤마 기준 줄바꿈
    const programOperations = document.querySelector('.program-operations');
    if (programOperations) {
        const text = programOperations.textContent;
        const formattedText = text.replace(/,/g, ',\n');
        programOperations.textContent = formattedText;
    }
    
    // 교통편 - <ㅇㅇ이용시> 기준 줄바꿈
    const transportationInfo = document.querySelector('.transportation-info');
    if (transportationInfo) {
        const text = transportationInfo.textContent;
        const formattedText = text.replace(/<([^>]+)이용시>/g, '\n<$1이용시>');
        transportationInfo.textContent = formattedText;
    }
    
    // 인력현황 - / 기준 줄바꿈
    const staffInfo = document.querySelector('.staff-info');
    if (staffInfo) {
        const text = staffInfo.textContent;
        const formattedText = text.replace(/\//g, '/\n');
        staffInfo.textContent = formattedText;
    }
}
</script>

</body>
</html>